#!/bin/sh
#
# This is a tool like llvm-config for the standalone MLIR built by flake.nix
# that is intended to support the uses in https://github.com/mlir-rs/mlir-sys
# but may not support all uses that the normal llvm-config supports.
#

error_and_quit() {
  echo "ERROR: $1" >&2
  echo "WARNING: This is a minimal llvm-config replacement that allows the" \
       "standalone MLIR built by https://github.com/project-llzk/llzk-nix-pkgs" \
       "to be used with https://github.com/mlir-rs/mlir-sys. It is not" \
       "guaranteed to support anything beyond the specific option" \
       "combinations used by mlir-sys." >&2
  echo "Usage: llvm-config --link-static [option]" >&2
  exit 1
}

# mlir-sys always uses '--link-static' as first argument
if [ "$1" != "--link-static" ]; then
  error_and_quit "Expected --link-static as first argument"
fi

case "$2" in
  --prefix)
    echo "@out@"
    ;;
  --bindir)
    echo "@out@/bin"
    ;;
  --includedir)
    echo "@out@/include"
    ;;
  --libdir)
    echo "@out@/lib"
    ;;
  --libs)
    # static library file names with -l prefix instead of lib*.a
    find "@out@/lib" -name "lib*.a" | \
    sed -e 's|.*/||' -e 's|\.a$||' -e 's|^lib|-l|' | \
    tr '\n' ' '
    echo
    ;;
  --libnames)
    # Just the static library file names
    find "@out@/lib" -name "lib*.a" | \
    sed 's|.*/||' | \
    tr '\n' ' '
    echo
    ;;
  *)
    @originalTool@ --link-static $2
    ;;
esac
